name: Deploy Backend to AWS Elastic Beanstalk

on:
  push:
    branches:
      - main
    paths:
      - 'backend/**'
      - '.github/workflows/backend-deploy-aws.yml'
  workflow_dispatch:

env:
  AWS_REGION: us-east-1
  EB_APPLICATION_NAME: nbcc-games-backend
  EB_ENVIRONMENT_NAME: nbcc-games-prod
  DEPLOY_PACKAGE_NAME: deploy-package-${{ github.sha }}.zip

jobs:
  test:
    name: Test Backend
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: backend
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: backend/requirements.txt
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Run migrations check
        run: |
          python manage.py makemigrations --check --dry-run
        env:
          DJANGO_SECRET_KEY: test-secret-key-for-ci
          DJANGO_DEBUG: 'False'
      
      - name: Run tests
        run: |
          python manage.py test
        env:
          DJANGO_SECRET_KEY: test-secret-key-for-ci
          DJANGO_DEBUG: 'False'

  deploy:
    name: Deploy to Elastic Beanstalk
    runs-on: ubuntu-latest
    needs: test
    defaults:
      run:
        working-directory: backend
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Create deployment package
        run: |
          # Remove unnecessary files
          rm -rf __pycache__ *.pyc .git .gitignore
          
          # Create zip file
          zip -r ${{ env.DEPLOY_PACKAGE_NAME }} . \
            -x "*.git*" \
            -x "*__pycache__*" \
            -x "*.pyc" \
            -x "*.pyo" \
            -x "*venv*" \
            -x "*.env*" \
            -x "*.sqlite3" \
            -x "*staticfiles*" \
            -x "*.coverage*" \
            -x "*htmlcov*"
          
          echo "‚úÖ Deployment package created: ${{ env.DEPLOY_PACKAGE_NAME }}"
      
      - name: Upload deployment package to S3
        run: |
          aws s3 cp ${{ env.DEPLOY_PACKAGE_NAME }} \
            s3://elasticbeanstalk-${{ env.AWS_REGION }}-${{ secrets.AWS_ACCOUNT_ID }}/${{ env.EB_APPLICATION_NAME }}/${{ env.DEPLOY_PACKAGE_NAME }}
      
      - name: Create new Elastic Beanstalk application version
        run: |
          aws elasticbeanstalk create-application-version \
            --application-name ${{ env.EB_APPLICATION_NAME }} \
            --version-label "ver-${{ github.sha }}" \
            --description "Deployed from GitHub Actions - Commit: ${{ github.sha }}" \
            --source-bundle S3Bucket="elasticbeanstalk-${{ env.AWS_REGION }}-${{ secrets.AWS_ACCOUNT_ID }}",S3Key="${{ env.EB_APPLICATION_NAME }}/${{ env.DEPLOY_PACKAGE_NAME }}"
      
      - name: Deploy to Elastic Beanstalk environment
        run: |
          aws elasticbeanstalk update-environment \
            --application-name ${{ env.EB_APPLICATION_NAME }} \
            --environment-name ${{ env.EB_ENVIRONMENT_NAME }} \
            --version-label "ver-${{ github.sha }}"
      
      - name: Wait for deployment to complete
        run: |
          echo "‚è≥ Waiting for deployment to complete..."
          
          TIMEOUT=600  # 10 minutes
          ELAPSED=0
          INTERVAL=15
          
          while [ $ELAPSED -lt $TIMEOUT ]; do
            STATUS=$(aws elasticbeanstalk describe-environments \
              --application-name ${{ env.EB_APPLICATION_NAME }} \
              --environment-names ${{ env.EB_ENVIRONMENT_NAME }} \
              --query 'Environments[0].Status' \
              --output text)
            
            HEALTH=$(aws elasticbeanstalk describe-environments \
              --application-name ${{ env.EB_APPLICATION_NAME }} \
              --environment-names ${{ env.EB_ENVIRONMENT_NAME }} \
              --query 'Environments[0].Health' \
              --output text)
            
            echo "Status: $STATUS | Health: $HEALTH"
            
            if [ "$STATUS" = "Ready" ]; then
              if [ "$HEALTH" = "Green" ] || [ "$HEALTH" = "Yellow" ]; then
                echo "‚úÖ Deployment completed successfully!"
                exit 0
              elif [ "$HEALTH" = "Red" ]; then
                echo "‚ùå Deployment failed - Health is Red"
                exit 1
              fi
            fi
            
            sleep $INTERVAL
            ELAPSED=$((ELAPSED + INTERVAL))
          done
          
          echo "‚ö†Ô∏è Deployment timeout after $TIMEOUT seconds"
          exit 1
      
      - name: Get application URL
        if: success()
        run: |
          URL=$(aws elasticbeanstalk describe-environments \
            --application-name ${{ env.EB_APPLICATION_NAME }} \
            --environment-names ${{ env.EB_ENVIRONMENT_NAME }} \
            --query 'Environments[0].CNAME' \
            --output text)
          
          echo "üåê Application deployed to: http://$URL"
          echo "::notice::Backend deployed successfully to http://$URL"
      
      - name: Deployment failed notification
        if: failure()
        run: |
          echo "::error::Deployment to Elastic Beanstalk failed"
          echo "Check logs with: aws elasticbeanstalk request-environment-info --environment-name ${{ env.EB_ENVIRONMENT_NAME }} --info-type tail"
